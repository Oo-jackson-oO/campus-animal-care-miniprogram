# æ ¡å›­æµæµªåŠ¨ç‰©å®ˆæŠ¤å°ç¨‹åº - éƒ¨ç½²æŒ‡å—

## ğŸ“‹ éƒ¨ç½²æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†æè¿°äº†å¦‚ä½•å°†æ ¡å›­æµæµªåŠ¨ç‰©å®ˆæŠ¤å°ç¨‹åºä»å¼€å‘ç¯å¢ƒéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ŒåŒ…æ‹¬åç«¯APIæœåŠ¡ã€æ•°æ®åº“å’Œå‰ç«¯å°ç¨‹åºçš„å®Œæ•´éƒ¨ç½²æµç¨‹ã€‚

## ğŸ—ï¸ éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”Ÿäº§ç¯å¢ƒæ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CDN (é™æ€èµ„æº)                                             â”‚
â”‚  â”œâ”€â”€ å›¾ç‰‡èµ„æº                                               â”‚
â”‚  â”œâ”€â”€ æ ·å¼æ–‡ä»¶                                               â”‚
â”‚  â””â”€â”€ è„šæœ¬æ–‡ä»¶                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è´Ÿè½½å‡è¡¡å™¨ (Nginx)                                         â”‚
â”‚  â”œâ”€â”€ SSLç»ˆæ­¢                                                â”‚
â”‚  â”œâ”€â”€ è¯·æ±‚åˆ†å‘                                               â”‚
â”‚  â””â”€â”€ é™æ€æ–‡ä»¶æœåŠ¡                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åº”ç”¨æœåŠ¡å™¨ (Node.js)                                       â”‚
â”‚  â”œâ”€â”€ APIæœåŠ¡ (å¤šå®ä¾‹)                                       â”‚
â”‚  â”œâ”€â”€ è¿›ç¨‹ç®¡ç† (PM2)                                         â”‚
â”‚  â””â”€â”€ æ—¥å¿—ç®¡ç†                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•°æ®åº“æœåŠ¡å™¨ (MySQL)                                       â”‚
â”‚  â”œâ”€â”€ ä¸»æ•°æ®åº“                                               â”‚
â”‚  â”œâ”€â”€ å¤‡ä»½æ•°æ®åº“                                             â”‚
â”‚  â””â”€â”€ ç›‘æ§å‘Šè­¦                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¼“å­˜æœåŠ¡å™¨ (Redis)                                         â”‚
â”‚  â”œâ”€â”€ ä¼šè¯å­˜å‚¨                                               â”‚
â”‚  â”œâ”€â”€ æ•°æ®ç¼“å­˜                                               â”‚
â”‚  â””â”€â”€ é™æµæ§åˆ¶                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### æ–¹æ¡ˆä¸€: äº‘æœåŠ¡å™¨éƒ¨ç½²

#### 1. æœåŠ¡å™¨å‡†å¤‡

**æ¨èé…ç½®**:
- CPU: 2æ ¸å¿ƒä»¥ä¸Š
- å†…å­˜: 4GBä»¥ä¸Š
- å­˜å‚¨: 50GBä»¥ä¸ŠSSD
- ç½‘ç»œ: 5Mbpsä»¥ä¸Šå¸¦å®½
- æ“ä½œç³»ç»Ÿ: Ubuntu 20.04 LTS

#### 2. ç¯å¢ƒå®‰è£…

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£…Node.js
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
sudo apt-get install -y nodejs

# å®‰è£…MySQL
sudo apt install mysql-server -y

# å®‰è£…Nginx
sudo apt install nginx -y

# å®‰è£…Redis
sudo apt install redis-server -y

# å®‰è£…PM2
sudo npm install -g pm2
```

#### 3. æ•°æ®åº“é…ç½®

```bash
# å¯åŠ¨MySQLæœåŠ¡
sudo systemctl start mysql
sudo systemctl enable mysql

# å®‰å…¨é…ç½®
sudo mysql_secure_installation

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
mysql -u root -p
```

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE campus_animal_care CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- åˆ›å»ºç”¨æˆ·
CREATE USER 'campus_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON campus_animal_care.* TO 'campus_user'@'localhost';
FLUSH PRIVILEGES;

-- å¯¼å…¥æ•°æ®
USE campus_animal_care;
SOURCE /path/to/database/init.sql;
SOURCE /path/to/database/sample_data.sql;
```

#### 4. åº”ç”¨éƒ¨ç½²

```bash
# åˆ›å»ºåº”ç”¨ç›®å½•
sudo mkdir -p /var/www/campus-animal-care
sudo chown -R $USER:$USER /var/www/campus-animal-care

# å…‹éš†ä»£ç 
cd /var/www/campus-animal-care
git clone https://github.com/your-repo/campus-animal-care.git .

# å®‰è£…ä¾èµ–
cd backend
npm install --production

# é…ç½®ç¯å¢ƒå˜é‡
cp config.example.env .env
nano .env
```

```bash
# .env é…ç½®
NODE_ENV=production
PORT=3000
DB_HOST=localhost
DB_PORT=3306
DB_USER=campus_user
DB_PASSWORD=your_secure_password
DB_NAME=campus_animal_care
JWT_SECRET=your_jwt_secret_key
```

#### 5. å¯åŠ¨æœåŠ¡

```bash
# ä½¿ç”¨PM2å¯åŠ¨åº”ç”¨
cd /var/www/campus-animal-care/backend
pm2 start server.js --name "campus-api"
pm2 save
pm2 startup

# é…ç½®Nginx
sudo nano /etc/nginx/sites-available/campus-animal-care
```

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # é‡å®šå‘åˆ°HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSLé…ç½®
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;

    # APIä»£ç†
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # é™æ€æ–‡ä»¶
    location /static/ {
        alias /var/www/campus-animal-care/public/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # å¥åº·æ£€æŸ¥
    location /health {
        proxy_pass http://localhost:3000/health;
        access_log off;
    }
}
```

```bash
# å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/campus-animal-care /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### æ–¹æ¡ˆäºŒ: Dockeréƒ¨ç½²

#### 1. Docker Composeé…ç½®

```yaml
# docker-compose.yml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: campus-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: campus_animal_care
      MYSQL_USER: campus_user
      MYSQL_PASSWORD: user_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./database/sample_data.sql:/docker-entrypoint-initdb.d/sample_data.sql
    ports:
      - "3306:3306"
    networks:
      - campus-network

  redis:
    image: redis:7-alpine
    container_name: campus-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - campus-network

  api:
    build: ./backend
    container_name: campus-api
    environment:
      NODE_ENV: production
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: campus_user
      DB_PASSWORD: user_password
      DB_NAME: campus_animal_care
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "3000:3000"
    depends_on:
      - mysql
      - redis
    networks:
      - campus-network
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: campus-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./backend/public:/var/www/public
    depends_on:
      - api
    networks:
      - campus-network
    restart: unless-stopped

volumes:
  mysql_data:
  redis_data:

networks:
  campus-network:
    driver: bridge
```

#### 2. Dockerfile

```dockerfile
# backend/Dockerfile
FROM node:16-alpine

WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./

# å®‰è£…ä¾èµ–
RUN npm ci --only=production

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001

# æ›´æ”¹æ–‡ä»¶æ‰€æœ‰æƒ
RUN chown -R nodejs:nodejs /app
USER nodejs

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨åº”ç”¨
CMD ["node", "server.js"]
```

#### 3. éƒ¨ç½²å‘½ä»¤

```bash
# æ„å»ºå’Œå¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f api

# åœæ­¢æœåŠ¡
docker-compose down
```

### æ–¹æ¡ˆä¸‰: äº‘å¹³å°éƒ¨ç½²

#### 1. é˜¿é‡Œäº‘éƒ¨ç½²

**ECS + RDS + OSS**

```bash
# 1. åˆ›å»ºECSå®ä¾‹
# 2. åˆ›å»ºRDS MySQLå®ä¾‹
# 3. åˆ›å»ºOSSå­˜å‚¨æ¡¶
# 4. é…ç½®å®‰å…¨ç»„è§„åˆ™

# å®‰è£…åº”ç”¨
sudo yum update -y
sudo yum install -y nodejs npm git

# éƒ¨ç½²åº”ç”¨
git clone https://github.com/your-repo/campus-animal-care.git
cd campus-animal-care/backend
npm install --production

# é…ç½®ç¯å¢ƒå˜é‡
export DB_HOST=your-rds-endpoint
export DB_USER=your-username
export DB_PASSWORD=your-password
export DB_NAME=campus_animal_care

# å¯åŠ¨åº”ç”¨
pm2 start server.js --name campus-api
```

#### 2. è…¾è®¯äº‘éƒ¨ç½²

**CVM + TencentDB + COS**

```bash
# 1. åˆ›å»ºCVMå®ä¾‹
# 2. åˆ›å»ºTencentDB MySQLå®ä¾‹
# 3. åˆ›å»ºCOSå­˜å‚¨æ¡¶
# 4. é…ç½®å®‰å…¨ç»„

# éƒ¨ç½²æ­¥éª¤ç±»ä¼¼é˜¿é‡Œäº‘
```

#### 3. åä¸ºäº‘éƒ¨ç½²

**ECS + RDS + OBS**

```bash
# 1. åˆ›å»ºECSå®ä¾‹
# 2. åˆ›å»ºRDS MySQLå®ä¾‹
# 3. åˆ›å»ºOBSå­˜å‚¨æ¡¶
# 4. é…ç½®å®‰å…¨ç»„

# éƒ¨ç½²æ­¥éª¤ç±»ä¼¼å…¶ä»–äº‘å¹³å°
```

## ğŸ”§ è¯¦ç»†é…ç½®

### æ•°æ®åº“ä¼˜åŒ–

#### MySQLé…ç½®ä¼˜åŒ–

```ini
# /etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
# åŸºç¡€é…ç½®
port = 3306
bind-address = 0.0.0.0
max_connections = 200
max_connect_errors = 1000

# å†…å­˜é…ç½®
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
innodb_log_buffer_size = 16M
query_cache_size = 64M
query_cache_limit = 2M

# æ€§èƒ½é…ç½®
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT
innodb_file_per_table = 1
innodb_open_files = 400

# æ—¥å¿—é…ç½®
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
log_queries_not_using_indexes = 1

# å­—ç¬¦é›†é…ç½®
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
```

#### æ•°æ®åº“å¤‡ä»½

```bash
#!/bin/bash
# backup.sh

# é…ç½®
DB_NAME="campus_animal_care"
DB_USER="campus_user"
DB_PASS="your_password"
BACKUP_DIR="/var/backups/mysql"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å…¨é‡å¤‡ä»½
mysqldump -u$DB_USER -p$DB_PASS \
  --single-transaction \
  --routines \
  --triggers \
  $DB_NAME > $BACKUP_DIR/full_backup_$DATE.sql

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
gzip $BACKUP_DIR/full_backup_$DATE.sql

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "full_backup_*.sql.gz" -mtime +7 -delete

echo "å¤‡ä»½å®Œæˆ: full_backup_$DATE.sql.gz"
```

### åº”ç”¨ä¼˜åŒ–

#### PM2é…ç½®

```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'campus-api',
    script: 'server.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'development',
      PORT: 3000
    },
    env_production: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    log_file: './logs/combined.log',
    out_file: './logs/out.log',
    error_file: './logs/error.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    max_memory_restart: '1G',
    node_args: '--max-old-space-size=1024'
  }]
};
```

#### Nginxä¼˜åŒ–

```nginx
# nginx.conf
worker_processes auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    # åŸºç¡€é…ç½®
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 10M;

    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # ç¼“å­˜é…ç½®
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=1g inactive=60m;

    # é™æµé…ç½®
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    # ä¸Šæ¸¸æœåŠ¡å™¨
    upstream api_backend {
        server 127.0.0.1:3000;
        keepalive 32;
    }

    server {
        listen 80;
        server_name your-domain.com;
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name your-domain.com;

        # SSLé…ç½®
        ssl_certificate /path/to/certificate.crt;
        ssl_certificate_key /path/to/private.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
        ssl_prefer_server_ciphers off;

        # å®‰å…¨å¤´
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # APIä»£ç†
        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;
            
            proxy_pass http://api_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
            
            # ç¼“å­˜é…ç½®
            proxy_cache api_cache;
            proxy_cache_valid 200 302 10m;
            proxy_cache_valid 404 1m;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        }

        # å¥åº·æ£€æŸ¥
        location /health {
            proxy_pass http://api_backend/health;
            access_log off;
        }

        # é™æ€æ–‡ä»¶
        location /static/ {
            alias /var/www/campus-animal-care/public/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

### ç›‘æ§é…ç½®

#### ç³»ç»Ÿç›‘æ§

```bash
# å®‰è£…ç›‘æ§å·¥å…·
sudo apt install htop iotop nethogs -y

# é…ç½®æ—¥å¿—è½®è½¬
sudo nano /etc/logrotate.d/campus-animal-care
```

```
/var/www/campus-animal-care/backend/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 nodejs nodejs
    postrotate
        pm2 reloadLogs
    endscript
}
```

#### åº”ç”¨ç›‘æ§

```javascript
// backend/utils/monitor.js
const os = require('os');
const fs = require('fs');

class SystemMonitor {
  static getSystemInfo() {
    return {
      uptime: process.uptime(),
      memory: process.memoryUsage(),
      cpu: process.cpuUsage(),
      platform: os.platform(),
      arch: os.arch(),
      totalMemory: os.totalmem(),
      freeMemory: os.freemem(),
      loadAverage: os.loadavg()
    };
  }

  static getDiskUsage() {
    try {
      const stats = fs.statSync('/');
      return {
        total: stats.size,
        free: stats.free,
        used: stats.size - stats.free
      };
    } catch (error) {
      return null;
    }
  }

  static checkHealth() {
    const systemInfo = this.getSystemInfo();
    const diskUsage = this.getDiskUsage();
    
    return {
      status: 'healthy',
      timestamp: new Date().toISOString(),
      system: systemInfo,
      disk: diskUsage,
      uptime: process.uptime()
    };
  }
}

module.exports = SystemMonitor;
```

## ğŸ”’ å®‰å…¨é…ç½®

### SSLè¯ä¹¦é…ç½®

#### Let's Encryptå…è´¹è¯ä¹¦

```bash
# å®‰è£…Certbot
sudo apt install certbot python3-certbot-nginx -y

# è·å–è¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ : 0 12 * * * /usr/bin/certbot renew --quiet
```

#### å•†ä¸šSSLè¯ä¹¦

```bash
# è´­ä¹°è¯ä¹¦åï¼Œå°†è¯ä¹¦æ–‡ä»¶æ”¾åˆ°æŒ‡å®šä½ç½®
sudo mkdir -p /etc/nginx/ssl
sudo cp your-certificate.crt /etc/nginx/ssl/
sudo cp your-private.key /etc/nginx/ssl/
sudo chmod 600 /etc/nginx/ssl/your-private.key
```

### é˜²ç«å¢™é…ç½®

```bash
# é…ç½®UFWé˜²ç«å¢™
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable

# æŸ¥çœ‹çŠ¶æ€
sudo ufw status
```

### æ•°æ®åº“å®‰å…¨

```sql
-- åˆ›å»ºåªè¯»ç”¨æˆ·
CREATE USER 'readonly_user'@'%' IDENTIFIED BY 'readonly_password';
GRANT SELECT ON campus_animal_care.* TO 'readonly_user'@'%';

-- åˆ›å»ºå¤‡ä»½ç”¨æˆ·
CREATE USER 'backup_user'@'localhost' IDENTIFIED BY 'backup_password';
GRANT SELECT, LOCK TABLES ON campus_animal_care.* TO 'backup_user'@'localhost';

-- åˆ·æ–°æƒé™
FLUSH PRIVILEGES;
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–

#### ç´¢å¼•ä¼˜åŒ–

```sql
-- ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
CREATE INDEX idx_animals_species_status ON animals(species, status);
CREATE INDEX idx_animals_created_at ON animals(created_at);
CREATE INDEX idx_comments_animal_id_created_at ON comments(animal_id, created_at);
CREATE INDEX idx_donations_status_created_at ON donations(status, created_at);
CREATE INDEX idx_users_openid ON users(openid);
```

#### æŸ¥è¯¢ä¼˜åŒ–

```sql
-- åˆ†ææ…¢æŸ¥è¯¢
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'long_query_time';

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;
```

### åº”ç”¨ä¼˜åŒ–

#### ç¼“å­˜é…ç½®

```javascript
// backend/utils/cache.js
const Redis = require('redis');

class CacheManager {
  constructor() {
    this.client = Redis.createClient({
      host: process.env.REDIS_HOST || 'localhost',
      port: process.env.REDIS_PORT || 6379
    });
  }

  async get(key) {
    try {
      const value = await this.client.get(key);
      return value ? JSON.parse(value) : null;
    } catch (error) {
      console.error('ç¼“å­˜è·å–å¤±è´¥:', error);
      return null;
    }
  }

  async set(key, value, ttl = 300) {
    try {
      await this.client.setex(key, ttl, JSON.stringify(value));
    } catch (error) {
      console.error('ç¼“å­˜è®¾ç½®å¤±è´¥:', error);
    }
  }

  async del(key) {
    try {
      await this.client.del(key);
    } catch (error) {
      console.error('ç¼“å­˜åˆ é™¤å¤±è´¥:', error);
    }
  }
}

module.exports = new CacheManager();
```

#### è¿æ¥æ± ä¼˜åŒ–

```javascript
// backend/config/database.js
const dbConfig = {
  // ... å…¶ä»–é…ç½®
  connectionLimit: 20,
  queueLimit: 0,
  acquireTimeout: 60000,
  timeout: 60000,
  reconnect: true,
  keepAliveInitialDelay: 0,
  enableKeepAlive: true
};
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep :3000

# æ£€æŸ¥è¿›ç¨‹
ps aux | grep node

# æŸ¥çœ‹æ—¥å¿—
pm2 logs campus-api
tail -f /var/log/nginx/error.log
```

#### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥MySQLçŠ¶æ€
sudo systemctl status mysql

# æ£€æŸ¥è¿æ¥
mysql -u campus_user -p -h localhost campus_animal_care

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/mysql/error.log
```

#### 3. æ€§èƒ½é—®é¢˜

```bash
# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
htop
iotop
nethogs

# æŸ¥çœ‹æ•°æ®åº“æ€§èƒ½
mysql -u root -p -e "SHOW PROCESSLIST;"
mysql -u root -p -e "SHOW STATUS LIKE 'Threads_connected';"
```

### æ—¥å¿—åˆ†æ

#### åº”ç”¨æ—¥å¿—

```bash
# æŸ¥çœ‹PM2æ—¥å¿—
pm2 logs campus-api --lines 100

# æŸ¥çœ‹Nginxæ—¥å¿—
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
sudo journalctl -u nginx -f
```

#### æ•°æ®åº“æ—¥å¿—

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;

-- æŸ¥çœ‹é”™è¯¯æ—¥å¿—
SHOW VARIABLES LIKE 'log_error';
```

## ğŸ“ˆ ç›‘æ§å‘Šè­¦

### ç³»ç»Ÿç›‘æ§

```bash
# å®‰è£…ç›‘æ§å·¥å…·
sudo apt install htop iotop nethogs -y

# é…ç½®ç›‘æ§è„šæœ¬
nano /usr/local/bin/system-monitor.sh
```

```bash
#!/bin/bash
# system-monitor.sh

# æ£€æŸ¥CPUä½¿ç”¨ç‡
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}')
if (( $(echo "$CPU_USAGE > 80" | bc -l) )); then
    echo "CPUä½¿ç”¨ç‡è¿‡é«˜: $CPU_USAGE%"
fi

# æ£€æŸ¥å†…å­˜ä½¿ç”¨ç‡
MEMORY_USAGE=$(free | grep Mem | awk '{printf("%.2f"), $3/$2 * 100.0}')
if (( $(echo "$MEMORY_USAGE > 80" | bc -l) )); then
    echo "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: $MEMORY_USAGE%"
fi

# æ£€æŸ¥ç£ç›˜ä½¿ç”¨ç‡
DISK_USAGE=$(df -h / | awk 'NR==2{print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: $DISK_USAGE%"
fi
```

### åº”ç”¨ç›‘æ§

```javascript
// backend/middleware/monitor.js
const monitor = require('../utils/monitor');

function monitorMiddleware(req, res, next) {
  const startTime = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - startTime;
    const systemInfo = monitor.getSystemInfo();
    
    // è®°å½•æ€§èƒ½æŒ‡æ ‡
    console.log({
      method: req.method,
      url: req.url,
      statusCode: res.statusCode,
      duration: duration,
      memory: systemInfo.memory,
      timestamp: new Date().toISOString()
    });
    
    // æ€§èƒ½å‘Šè­¦
    if (duration > 5000) {
      console.warn(`æ…¢è¯·æ±‚å‘Šè­¦: ${req.method} ${req.url} è€—æ—¶ ${duration}ms`);
    }
  });
  
  next();
}

module.exports = monitorMiddleware;
```

## ğŸ”„ å¤‡ä»½æ¢å¤

### è‡ªåŠ¨å¤‡ä»½

```bash
#!/bin/bash
# auto-backup.sh

# é…ç½®
DB_NAME="campus_animal_care"
DB_USER="backup_user"
DB_PASS="backup_password"
BACKUP_DIR="/var/backups/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å…¨é‡å¤‡ä»½
mysqldump -u$DB_USER -p$DB_PASS \
  --single-transaction \
  --routines \
  --triggers \
  --events \
  $DB_NAME > $BACKUP_DIR/full_backup_$DATE.sql

# å‹ç¼©å¤‡ä»½
gzip $BACKUP_DIR/full_backup_$DATE.sql

# ä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
# aws s3 cp $BACKUP_DIR/full_backup_$DATE.sql.gz s3://your-backup-bucket/

# æ¸…ç†æ—§å¤‡ä»½
find $BACKUP_DIR -name "full_backup_*.sql.gz" -mtime +$RETENTION_DAYS -delete

echo "å¤‡ä»½å®Œæˆ: full_backup_$DATE.sql.gz"
```

### æ•°æ®æ¢å¤

```bash
#!/bin/bash
# restore.sh

# é…ç½®
DB_NAME="campus_animal_care"
DB_USER="campus_user"
DB_PASS="your_password"
BACKUP_FILE="$1"

if [ -z "$BACKUP_FILE" ]; then
    echo "ç”¨æ³•: $0 <å¤‡ä»½æ–‡ä»¶>"
    exit 1
fi

# è§£å‹å¤‡ä»½æ–‡ä»¶
gunzip $BACKUP_FILE

# æ¢å¤æ•°æ®åº“
mysql -u$DB_USER -p$DB_PASS $DB_NAME < ${BACKUP_FILE%.gz}

echo "æ•°æ®æ¢å¤å®Œæˆ"
```

## ğŸ“š ç»´æŠ¤æŒ‡å—

### æ—¥å¸¸ç»´æŠ¤

#### æ¯æ—¥æ£€æŸ¥

```bash
#!/bin/bash
# daily-check.sh

echo "=== ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ ==="
echo "æ—¶é—´: $(date)"
echo ""

echo "=== æœåŠ¡çŠ¶æ€ ==="
systemctl status nginx
systemctl status mysql
pm2 status

echo "=== ç£ç›˜ä½¿ç”¨ ==="
df -h

echo "=== å†…å­˜ä½¿ç”¨ ==="
free -h

echo "=== ç½‘ç»œè¿æ¥ ==="
netstat -tlnp | grep :3000
netstat -tlnp | grep :3306

echo "=== æ—¥å¿—å¤§å° ==="
du -sh /var/log/nginx/
du -sh /var/www/campus-animal-care/backend/logs/
```

#### æ¯å‘¨ç»´æŠ¤

```bash
#!/bin/bash
# weekly-maintenance.sh

echo "=== æ¯å‘¨ç»´æŠ¤å¼€å§‹ ==="

# æ¸…ç†æ—¥å¿—
sudo logrotate -f /etc/logrotate.d/campus-animal-care

# æ›´æ–°ç³»ç»ŸåŒ…
sudo apt update
sudo apt upgrade -y

# é‡å¯æœåŠ¡
pm2 restart campus-api

# ä¼˜åŒ–æ•°æ®åº“
mysql -u root -p -e "OPTIMIZE TABLE campus_animal_care.animals;"
mysql -u root -p -e "OPTIMIZE TABLE campus_animal_care.products;"
mysql -u root -p -e "OPTIMIZE TABLE campus_animal_care.users;"

echo "=== æ¯å‘¨ç»´æŠ¤å®Œæˆ ==="
```

### ç‰ˆæœ¬æ›´æ–°

```bash
#!/bin/bash
# update.sh

echo "=== å¼€å§‹æ›´æ–° ==="

# å¤‡ä»½å½“å‰ç‰ˆæœ¬
cp -r /var/www/campus-animal-care /var/www/campus-animal-care.backup.$(date +%Y%m%d)

# æ‹‰å–æœ€æ–°ä»£ç 
cd /var/www/campus-animal-care
git pull origin main

# å®‰è£…æ–°ä¾èµ–
cd backend
npm install --production

# é‡å¯æœåŠ¡
pm2 restart campus-api

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
pm2 status

echo "=== æ›´æ–°å®Œæˆ ==="
```

---

**æ³¨æ„**: æœ¬éƒ¨ç½²æŒ‡å—åŸºäºUbuntu 20.04 LTSç¼–å†™ï¼Œå…¶ä»–æ“ä½œç³»ç»Ÿå¯èƒ½éœ€è¦è°ƒæ•´å‘½ä»¤ã€‚ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰è¯·å……åˆ†æµ‹è¯•ã€‚

